name: Run DataGenerator Utility

on:
  workflow_dispatch:
    inputs:
      rows:
        description: 'Number of rows to generate'
        required: false
        default: '10'
      max_workers:
        description: 'Number of workers to use'
        required: false
        default: 4
      max_memory_mb:
        description: 'Memory limit in MB'
        required: false
        default: 1024
      input_method:
        description: 'Input method for JSON file'
        required: true
        type: choice
        options:
          - 'url'
          - 'repository_file'
        default: 'repository_file'

      file_url:
        description: 'URL of JSON file (if input_method is "url")'
        required: false
        default: 'https://raw.githubusercontent.com/sunnygupta4197/DataGenerator/master/examples/example5.json'
      repository_file_path:
        description: 'Repository file path (if input_method is "repository_file")'
        required: false
        default: 'examples/example3.json'

      notification_level:
        description: 'ğŸ”” Notification level'
        required: false
        type: choice
        options:
          - 'basic'           # Just workflow summary
          - 'enhanced'        # Summary + issue comments
          - 'team'           # Summary + Slack
          - 'enterprise'     # Summary + Slack + webhooks
          - 'custom'         # Use custom notification config
        default: 'enhanced'
      slack_webhook_url:
        description: 'ğŸ“± Slack webhook URL (for team/enterprise levels)'
        required: false
      custom_webhook_url:
        description: 'ğŸ”— Custom webhook URL (for enterprise/custom levels)'
        required: false
      email_address:
        description: 'ğŸ“§ Email for notifications (generates email content)'
        required: false

  # Issue-based file upload trigger
  issues:
    types: [opened, edited]

  # Pull request based file upload
  pull_request:
    paths: ['uploads/**/*.json']
    types: [opened, synchronize]

# Required permissions
permissions:
  contents: read
  actions: read
  issues: write
  pull-requests: write
  id-token: write

# Global environment variables for optimization
env:
  PYTHONUNBUFFERED: 1
  PIP_DISABLE_PIP_VERSION_CHECK: 1
  PIP_NO_COLOR: 1

jobs:
  # Main job for manual workflow dispatch
  run-script-manual:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¢ Initialize and configure notifications
        id: init
        run: |
          echo "ğŸš€ DataGenerator workflow starting..."
          echo "ğŸ”” Notification level: ${{ github.event.inputs.notification_level }}"
          
          # Set notification flags based on level
          LEVEL="${{ github.event.inputs.notification_level }}"
          case $LEVEL in
            "basic")
              ENABLE_SUMMARY="true"
              ENABLE_SLACK="false"
              ENABLE_ISSUES="false"
              ENABLE_WEBHOOK="false"
              ENABLE_EMAIL="false"
              ;;
            "enhanced")
              ENABLE_SUMMARY="true"
              ENABLE_SLACK="false"
              ENABLE_ISSUES="true"
              ENABLE_WEBHOOK="false"
              ENABLE_EMAIL="false"
              ;;
            "team")
              ENABLE_SUMMARY="true"
              ENABLE_SLACK="true"
              ENABLE_ISSUES="true"
              ENABLE_WEBHOOK="false"
              ENABLE_EMAIL="false"
              ;;
            "enterprise")
              ENABLE_SUMMARY="true"
              ENABLE_SLACK="true"
              ENABLE_ISSUES="true"
              ENABLE_WEBHOOK="true"
              ENABLE_EMAIL="true"
              ;;
            "custom")
              ENABLE_SUMMARY="true"
              ENABLE_SLACK="${{ github.event.inputs.slack_webhook_url != '' && 'true' || 'false' }}"
              ENABLE_ISSUES="true"
              ENABLE_WEBHOOK="${{ github.event.inputs.custom_webhook_url != '' && 'true' || 'false' }}"
              ENABLE_EMAIL="${{ github.event.inputs.email_address != '' && 'true' || 'false' }}"
              ;;
            *)
              ENABLE_SUMMARY="true"
              ENABLE_SLACK="false"
              ENABLE_ISSUES="false"
              ENABLE_WEBHOOK="false"
              ENABLE_EMAIL="false"
              ;;
          esac
          
          # Set outputs for all steps
          echo "enable_summary=$ENABLE_SUMMARY" >> $GITHUB_OUTPUT
          echo "enable_slack=$ENABLE_SLACK" >> $GITHUB_OUTPUT
          echo "enable_issues=$ENABLE_ISSUES" >> $GITHUB_OUTPUT
          echo "enable_webhook=$ENABLE_WEBHOOK" >> $GITHUB_OUTPUT
          echo "enable_email=$ENABLE_EMAIL" >> $GITHUB_OUTPUT
          echo "start_time=$(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_OUTPUT
          echo "run_url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Notification configuration:"
          echo "  - Summary: $ENABLE_SUMMARY"
          echo "  - Slack: $ENABLE_SLACK"
          echo "  - Issues: $ENABLE_ISSUES"  
          echo "  - Webhook: $ENABLE_WEBHOOK"
          echo "  - Email: $ENABLE_EMAIL"

      # Workflow summary (always enabled)
      - name: ğŸ“‹ Create workflow summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ğŸš€ DataGenerator Started!
          
          ## ğŸ“Š Run Configuration
          | Parameter | Value |
          |-----------|-------|
          | ğŸ‘¤ **Triggered by** | @${{ github.actor }} |
          | ğŸ•’ **Started at** | ${{ steps.init.outputs.start_time }} |
          | ğŸ†” **Run ID** | [${{ github.run_id }}](${{ steps.init.outputs.run_url }}) |
          | ğŸ“¥ **Input Method** | ${{ github.event.inputs.input_method }} |
          | ğŸ“ **Source** | ${{ github.event.inputs.input_method == 'url' && github.event.inputs.file_url || github.event.inputs.repository_file_path }} |
          | ğŸ”” **Notification Level** | ${{ github.event.inputs.notification_level }} |
          
          ## âš™ï¸ Processing Settings
          | Setting | Value |
          |---------|-------|
          | ğŸ“ˆ **Rows** | ${{ github.event.inputs.rows }} |
          | âš™ï¸ **Workers** | ${{ github.event.inputs.max_workers }} |
          | ğŸ’¾ **Memory** | ${{ github.event.inputs.max_memory_mb }} MB |
          
          ## ğŸ”” Active Notifications
          - ${{ steps.init.outputs.enable_summary == 'true' && 'âœ…' || 'âŒ' }} **Workflow Summary** - This dashboard
          - ${{ steps.init.outputs.enable_slack == 'true' && 'âœ…' || 'âŒ' }} **Slack** - Team notifications
          - ${{ steps.init.outputs.enable_issues == 'true' && 'âœ…' || 'âŒ' }} **Issue Comments** - GitHub updates
          - ${{ steps.init.outputs.enable_webhook == 'true' && 'âœ…' || 'âŒ' }} **Custom Webhook** - API integration
          - ${{ steps.init.outputs.enable_email == 'true' && 'âœ…' || 'âŒ' }} **Email Preparation** - Email content
          
          ## ğŸ”— Quick Links
          - [ğŸ“Š Live Progress](${{ steps.init.outputs.run_url }})
          - [ğŸ“‹ All Runs](https://github.com/${{ github.repository }}/actions)
          - [ğŸ“ Repository](https://github.com/${{ github.repository }})
          
          ---
          â³ **Status**: Processing... (will update on completion)
          EOF

      # Conditional Slack notification
      - name: ğŸ“± Send Slack start notification
        if: steps.init.outputs.enable_slack == 'true' && github.event.inputs.slack_webhook_url != ''
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "ğŸš€ DataGenerator Started",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸš€ DataGenerator Started"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸ‘¤ User:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn", 
                      "text": "*ğŸ•’ Started:*\n${{ steps.init.outputs.start_time }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸ“ˆ Rows:*\n${{ github.event.inputs.rows }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸ”” Level:*\n${{ github.event.inputs.notification_level }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸ“ Input:* ${{ github.event.inputs.input_method == 'url' && 'ğŸŒ URL' || 'ğŸ“‚ Repository File' }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ğŸ“Š View Progress"
                      },
                      "url": "${{ steps.init.outputs.run_url }}"
                    }
                  ]
                }
              ]
            }' \
            "${{ github.event.inputs.slack_webhook_url }}"

      # Conditional issue comment
      - name: ğŸ’¬ Send issue comment notification
        if: steps.init.outputs.enable_issues == 'true'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            // Find or create notifications issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'notifications',
              per_page: 1
            });
            
            let issueNumber;
            if (issues.data.length > 0) {
              issueNumber = issues.data[0].number;
            } else {
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ”” DataGenerator Notifications Hub',
                body: 'This issue tracks DataGenerator workflow notifications. Subscribe for email updates!',
                labels: ['notifications', 'automated']
              });
              issueNumber = newIssue.data.number;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## ğŸš€ DataGenerator Started - Run #${{ github.run_number }}
              
              **ğŸ“Š Configuration:**
              - **ğŸ‘¤ User**: @${{ github.actor }}
              - **ğŸ•’ Started**: ${{ steps.init.outputs.start_time }}
              - **ğŸ“ˆ Rows**: ${{ github.event.inputs.rows }} | **âš™ï¸ Workers**: ${{ github.event.inputs.max_workers }} | **ğŸ’¾ Memory**: ${{ github.event.inputs.max_memory_mb }}MB
              - **ğŸ”” Level**: ${{ github.event.inputs.notification_level }}
              - **ğŸ“¥ Source**: ${{ github.event.inputs.input_method == 'url' && 'ğŸŒ URL' || 'ğŸ“‚ Repository File' }}
              
              **ğŸ”— [View Live Progress â†’](${{ steps.init.outputs.run_url }})**
              
              ---`
            });

      # Conditional webhook notification
      - name: ğŸ”— Send webhook start notification
        if: steps.init.outputs.enable_webhook == 'true' && github.event.inputs.custom_webhook_url != ''
        run: |
          curl -X POST -H 'Content-Type: application/json' \
            --data '{
              "event": "workflow_started",
              "workflow": "DataGenerator",
              "run_id": "${{ github.run_id }}",
              "run_number": ${{ github.run_number }},
              "actor": "${{ github.actor }}",
              "started_at": "${{ steps.init.outputs.start_time }}",
              "notification_level": "${{ github.event.inputs.notification_level }}",
              "parameters": {
                "input_method": "${{ github.event.inputs.input_method }}",
                "rows": ${{ github.event.inputs.rows }},
                "workers": ${{ github.event.inputs.max_workers }},
                "memory_mb": ${{ github.event.inputs.max_memory_mb }},
                "source": "${{ github.event.inputs.input_method == 'url' && github.event.inputs.file_url || github.event.inputs.repository_file_path }}"
              },
              "urls": {
                "workflow_run": "${{ steps.init.outputs.run_url }}",
                "repository": "https://github.com/${{ github.repository }}"
              },
              "status": "started"
            }' \
            "${{ github.event.inputs.custom_webhook_url }}"

      # Conditional email preparation
      - name: ğŸ“§ Prepare email start notification
        if: steps.init.outputs.enable_email == 'true' && github.event.inputs.email_address != ''
        run: |
          mkdir -p email_notifications
          cat > email_notifications/start_notification.txt << 'EOF'
          Subject: ğŸš€ DataGenerator Started - Run #${{ github.run_number }}
          To: ${{ github.event.inputs.email_address }}
          
          DataGenerator Workflow Started
          =============================
          
          Your DataGenerator workflow has started processing.
          
          Configuration:
          - User: ${{ github.actor }}
          - Started: ${{ steps.init.outputs.start_time }}
          - Notification Level: ${{ github.event.inputs.notification_level }}
          - Rows: ${{ github.event.inputs.rows }}
          - Workers: ${{ github.event.inputs.max_workers }}
          - Memory: ${{ github.event.inputs.max_memory_mb }} MB
          - Input Method: ${{ github.event.inputs.input_method }}
          - Source: ${{ github.event.inputs.input_method == 'url' && github.event.inputs.file_url || github.event.inputs.repository_file_path }}
          
          Track Progress: ${{ steps.init.outputs.run_url }}
          
          You will receive completion notification when processing finishes.
          
          ---
          Automated notification from DataGenerator
          Repository: ${{ github.repository }}
          EOF
          
          echo "ğŸ“§ Email content prepared for: ${{ github.event.inputs.email_address }}"

      # Main workflow execution steps
      - name: ğŸ“ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python with caching
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
          cache-dependency-path: '**/requirements.txt'

      - name: ğŸ“¦ Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.local/lib/python3.9/site-packages
          key: ${{ runner.os }}-python-deps-${{ hashFiles('**/requirements.txt', '**/setup.py', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-python-deps-

      - name: âš¡ Install dependencies (with caching)
        run: |
          python -m pip install --upgrade pip --quiet
          if [ -f requirements.txt ]; then 
            echo "ğŸ“‹ Installing from requirements.txt..."
            pip install -r requirements.txt --quiet --no-warn-script-location
          else
            echo "âš ï¸  No requirements.txt found, installing common packages..."
            pip install pandas numpy --quiet --no-warn-script-location
          fi

      - name: ğŸ“¥ Prepare input file
        run: |
          if [ "${{ github.event.inputs.input_method }}" = "url" ]; then
            echo "ğŸŒ Downloading from URL: ${{ github.event.inputs.file_url }}"
            curl -L -o input.json "${{ github.event.inputs.file_url }}" --silent --show-error
          else
            echo "ğŸ“ Using repository file: ${{ github.event.inputs.repository_file_path }}"
            cp "${{ github.event.inputs.repository_file_path }}" input.json
          fi

      - name: âœ… Validate input file
        run: |
          if [ ! -f input.json ]; then
            echo "âŒ Input file not found!"
            exit 1
          fi
          
          echo "ğŸ“Š Input file details:"
          ls -lh input.json
          echo "ğŸ” File preview (first 10 lines):"
          head -n 10 input.json

      - name: ğŸ§ª Validate JSON format
        run: |
          python -c "
          import json
          import sys
          try:
              with open('input.json', 'r') as f:
                  data = json.load(f)
              print('âœ… JSON file is valid')
              print(f'ğŸ“Š JSON structure: {len(data)} top-level items' if isinstance(data, (dict, list)) else 'ğŸ“Š JSON is a simple value')
          except json.JSONDecodeError as e:
              print(f'âŒ Invalid JSON file: {e}')
              sys.exit(1)
          except Exception as e:
              print(f'âŒ Error reading file: {e}')
              sys.exit(1)
          "

      - name: ğŸš€ Run DataGenerator
        run: |
          echo "ğŸ”§ Starting DataGenerator with parameters:"
          echo "  - Rows: ${{ github.event.inputs.rows }}"
          echo "  - Workers: ${{ github.event.inputs.max_workers }}"
          echo "  - Memory: ${{ github.event.inputs.max_memory_mb }} MB"
          
          python main.py \
            -c input.json \
            -r ${{ github.event.inputs.rows }} \
            --enable_all_features \
            --output_dir output_files \
            -f csv \
            -w ${{ github.event.inputs.max_workers }} \
            -m ${{ github.event.inputs.max_memory_mb }}

      - name: ğŸ“¤ Upload output artifacts
        uses: actions/upload-artifact@v4
        with:
          name: datagenerator-output-${{ github.run_number }}
          path: output_files/
          retention-days: 30

      - name: ğŸ“Š Gather completion results
        if: always()
        id: results
        run: |
          STATUS="${{ job.status }}"
          COMPLETION_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          if [ "$STATUS" = "success" ]; then
            EMOJI="ğŸ‰"
            STATUS_TEXT="âœ… Completed Successfully"
            COLOR="good"
          else
            EMOJI="ğŸ’¥"
            STATUS_TEXT="âŒ Failed"
            COLOR="danger"
          fi
          
          # Count output files and calculate sizes
          FILE_COUNT=0
          TOTAL_SIZE="0 B"
          FILE_LIST=""
          
          if [ -d "output_files" ]; then
            FILE_COUNT=$(ls output_files 2>/dev/null | wc -l)
            
            # Calculate total size (cross-platform compatible)
            if command -v du >/dev/null 2>&1; then
              TOTAL_BYTES=$(du -sb output_files 2>/dev/null | cut -f1 || echo "0")
              if [ "$TOTAL_BYTES" -gt 1048576 ]; then
                TOTAL_SIZE="$(echo "$TOTAL_BYTES" | awk '{printf "%.1fMB", $1/1048576}')"
              elif [ "$TOTAL_BYTES" -gt 1024 ]; then
                TOTAL_SIZE="$(echo "$TOTAL_BYTES" | awk '{printf "%.1fKB", $1/1024}')"
              else
                TOTAL_SIZE="${TOTAL_BYTES}B"
              fi
            fi
            
            # Create file list for notifications
            for file in output_files/*; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                FILE_LIST="$FILE_LIST\n- ğŸ“„ \`$filename\`"
              fi
            done
          fi
          
          # Set outputs for completion notifications
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "status_text=$STATUS_TEXT" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          echo "completion_time=$COMPLETION_TIME" >> $GITHUB_OUTPUT
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "total_size=$TOTAL_SIZE" >> $GITHUB_OUTPUT
          echo "file_list<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FILE_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # COMPLETION NOTIFICATIONS (ALL ENABLED METHODS)

      - name: ğŸ“‹ Update workflow summary (completion)
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          
          ---
          
          # ${{ steps.results.outputs.emoji }} DataGenerator ${{ steps.results.outputs.status_text }}
          
          ## ğŸ“Š Final Results
          | Metric | Value |
          |--------|-------|
          | ğŸ“ **Status** | ${{ steps.results.outputs.status_text }} |
          | â±ï¸ **Completed** | ${{ steps.results.outputs.completion_time }} |
          | ğŸ“„ **Files Generated** | ${{ steps.results.outputs.file_count }} |
          | ğŸ’¾ **Total Size** | ${{ steps.results.outputs.total_size }} |
          | ğŸ”” **Notification Level** | ${{ github.event.inputs.notification_level }} |
          
          ## ğŸ“„ Generated Files
          ${{ steps.results.outputs.file_list }}
          
          ## ğŸ“¥ Download & Actions
          - [ğŸ“¦ Download All Files](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [ğŸ“‹ View Complete Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [ğŸ”„ Run Again](https://github.com/${{ github.repository }}/actions)
          
          ## ğŸ”” Notification Summary
          All enabled notification channels were updated:
          - ${{ steps.init.outputs.enable_summary == 'true' && 'âœ…' || 'âŒ' }} Workflow Summary (this page)
          - ${{ steps.init.outputs.enable_slack == 'true' && 'âœ…' || 'âŒ' }} Slack Notifications  
          - ${{ steps.init.outputs.enable_issues == 'true' && 'âœ…' || 'âŒ' }} Issue Comments
          - ${{ steps.init.outputs.enable_webhook == 'true' && 'âœ…' || 'âŒ' }} Custom Webhook
          - ${{ steps.init.outputs.enable_email == 'true' && 'âœ…' || 'âŒ' }} Email Preparation
          
          ---
          ${{ steps.results.outputs.emoji }} **Workflow completed at ${{ steps.results.outputs.completion_time }}**
          EOF

      - name: ğŸ“± Send Slack completion notification
        if: steps.init.outputs.enable_slack == 'true' && github.event.inputs.slack_webhook_url != '' && always()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"${{ steps.results.outputs.emoji }} DataGenerator ${{ steps.results.outputs.status_text }}\",
              \"attachments\": [
                {
                  \"color\": \"${{ steps.results.outputs.color }}\",
                  \"fields\": [
                    {
                      \"title\": \"Status\",
                      \"value\": \"${{ steps.results.outputs.status_text }}\",
                      \"short\": true
                    },
                    {
                      \"title\": \"Files Generated\",
                      \"value\": \"${{ steps.results.outputs.file_count }}\",
                      \"short\": true
                    },
                    {
                      \"title\": \"Total Size\",
                      \"value\": \"${{ steps.results.outputs.total_size }}\",
                      \"short\": true
                    },
                    {
                      \"title\": \"Run Number\",
                      \"value\": \"#${{ github.run_number }}\",
                      \"short\": true
                    },
                    {
                      \"title\": \"Completed\",
                      \"value\": \"${{ steps.results.outputs.completion_time }}\",
                      \"short\": false
                    }
                  ],
                  \"actions\": [
                    {
                      \"type\": \"button\",
                      \"text\": \"ğŸ“¥ Download Results\",
                      \"url\": \"${{ steps.init.outputs.run_url }}\"
                    }
                  ]
                }
              ]
            }" \
            "${{ github.event.inputs.slack_webhook_url }}"

      - name: ğŸ’¬ Send issue completion comment
        if: steps.init.outputs.enable_issues == 'true' && always()
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'notifications',
              per_page: 1
            });
            
            if (issues.data.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `## ${{ steps.results.outputs.emoji }} Run #${{ github.run_number }} ${{ steps.results.outputs.status_text }}
                
                **ğŸ“Š Final Results:**
                - **â±ï¸ Completed**: ${{ steps.results.outputs.completion_time }}
                - **ğŸ“„ Files Generated**: ${{ steps.results.outputs.file_count }}
                - **ğŸ’¾ Total Size**: ${{ steps.results.outputs.total_size }}
                - **ğŸ“ Status**: ${{ steps.results.outputs.status_text }}
                
                **ğŸ“¥ Download Results**: [Workflow Artifacts](${{ steps.init.outputs.run_url }})
                
                ---
                *ğŸ¤– Workflow completed successfully!*`
              });
            }

      - name: ğŸ”— Send webhook completion notification
        if: steps.init.outputs.enable_webhook == 'true' && github.event.inputs.custom_webhook_url != '' && always()
        run: |
          curl -X POST -H 'Content-Type: application/json' \
            --data "{
              \"event\": \"workflow_completed\",
              \"workflow\": \"DataGenerator\",
              \"run_id\": \"${{ github.run_id }}\",
              \"run_number\": ${{ github.run_number }},
              \"actor\": \"${{ github.actor }}\",
              \"started_at\": \"${{ steps.init.outputs.start_time }}\",
              \"completed_at\": \"${{ steps.results.outputs.completion_time }}\",
              \"repository\": \"${{ github.repository }}\",
              \"status\": \"${{ steps.results.outputs.status }}\",
              \"status_text\": \"${{ steps.results.outputs.status_text }}\",
              \"notification_level\": \"${{ github.event.inputs.notification_level }}\",
              \"results\": {
                \"files_generated\": ${{ steps.results.outputs.file_count }},
                \"total_size\": \"${{ steps.results.outputs.total_size }}\",
                \"success\": ${{ steps.results.outputs.status == 'success' }}
              },
              \"parameters\": {
                \"input_method\": \"${{ github.event.inputs.input_method }}\",
                \"rows\": ${{ github.event.inputs.rows }},
                \"workers\": ${{ github.event.inputs.max_workers }},
                \"memory_mb\": ${{ github.event.inputs.max_memory_mb }}
              },
              \"urls\": {
                \"workflow_run\": \"${{ steps.init.outputs.run_url }}\",
                \"artifacts\": \"${{ steps.init.outputs.run_url }}\",
                \"repository\": \"https://github.com/${{ github.repository }}\"
              }
            }" \
            "${{ github.event.inputs.custom_webhook_url }}"

      - name: ğŸ“§ Prepare completion email notification
        if: steps.init.outputs.enable_email == 'true' && github.event.inputs.email_address != '' && always()
        run: |
          cat > email_notifications/completion_notification.txt << EOF
          Subject: ${{ steps.results.outputs.emoji }} DataGenerator ${{ steps.results.outputs.status_text }} - Run #${{ github.run_number }}
          To: ${{ github.event.inputs.email_address }}
          
          DataGenerator Workflow ${{ steps.results.outputs.status_text }}
          =============================================
          
          Your DataGenerator workflow has completed with the following results:
          
          Final Results:
          -------------
          - Status: ${{ steps.results.outputs.status_text }}
          - Completed: ${{ steps.results.outputs.completion_time }}
          - Files Generated: ${{ steps.results.outputs.file_count }}
          - Total Size: ${{ steps.results.outputs.total_size }}
          - Notification Level: ${{ github.event.inputs.notification_level }}
          
          Generated Files:
          ---------------
          ${{ steps.results.outputs.file_list }}
          
          Configuration Used:
          ------------------
          - User: ${{ github.actor }}
          - Started: ${{ steps.init.outputs.start_time }}
          - Input Method: ${{ github.event.inputs.input_method }}
          - Rows: ${{ github.event.inputs.rows }}
          - Workers: ${{ github.event.inputs.max_workers }}
          - Memory: ${{ github.event.inputs.max_memory_mb }} MB
          
          Download Results:
          ----------------
          Access your generated files: ${{ steps.init.outputs.run_url }}
          
          ---
          Automated notification from DataGenerator
          Repository: ${{ github.repository }}
          All enabled notification channels have been updated with these results.
          EOF
          
          echo "ğŸ“§ Completion email content prepared"

      - name: ğŸ“§ Upload email notifications as artifacts
        if: steps.init.outputs.enable_email == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: email-notifications-${{ github.run_number }}
          path: email_notifications/
          retention-days: 7

  # Issue-based job for file upload via issues
  run-script-issue:
    if: github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'data-upload')
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¢ Issue processing start notification
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸš€ DataGenerator Processing Started!
              
              **ğŸ“Š Status**: Processing your data file with enhanced notifications...
              **ğŸ•’ Started**: ${new Date().toISOString().replace('T', ' ').slice(0, 19)} UTC
              **ğŸ”— Live Progress**: [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              **ğŸ”” Enhancement**: Multi-channel notification system active
              
              I'll provide detailed updates when processing completes! ğŸ¯
              
              ---
              *ğŸ¤– Automated notification from DataGenerator workflow*`
            });

      - name: ğŸ“ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python with caching
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: âš¡ Install dependencies (cached)
        run: |
          python -m pip install --upgrade pip --quiet
          if [ -f requirements.txt ]; then 
            pip install -r requirements.txt --quiet --no-warn-script-location
          else
            pip install pandas numpy --quiet --no-warn-script-location
          fi

      - name: ğŸ“ Extract parameters from issue
        id: extract-params
        run: |
          ISSUE_BODY="${{ github.event.issue.body }}"
          
          # Extract file URL with multiple patterns
          FILE_URL=$(echo "$ISSUE_BODY" | grep -oE 'https?://[^[:space:]]+\.json[^[:space:]]*' | head -1)
          if [ -z "$FILE_URL" ]; then
            FILE_URL=$(echo "$ISSUE_BODY" | grep -oE 'https?://[^[:space:]]+' | grep -E '(raw\.githubusercontent|gist\.githubusercontent|file\.io|tmpfiles\.org)' | head -1)
          fi
          
          # Extract parameters with flexible formats
          ROWS=$(echo "$ISSUE_BODY" | grep -oiE '(rows?|count)[[:space:]]*:?[[:space:]]*([0-9]+)' | grep -oE '[0-9]+' | head -1)
          ROWS=${ROWS:-10}
          
          WORKERS=$(echo "$ISSUE_BODY" | grep -oiE '(workers?|threads?)[[:space:]]*:?[[:space:]]*([0-9]+)' | grep -oE '[0-9]+' | head -1)
          WORKERS=${WORKERS:-4}
          
          MEMORY=$(echo "$ISSUE_BODY" | grep -oiE '(memory|mem)[[:space:]]*:?[[:space:]]*([0-9]+)' | grep -oE '[0-9]+' | head -1)
          MEMORY=${MEMORY:-1024}
          
          echo "file_url=$FILE_URL" >> $GITHUB_OUTPUT
          echo "rows=$ROWS" >> $GITHUB_OUTPUT
          echo "workers=$WORKERS" >> $GITHUB_OUTPUT
          echo "memory=$MEMORY" >> $GITHUB_OUTPUT
          
          echo "ğŸ” Extracted parameters:"
          echo "  - File URL: $FILE_URL"
          echo "  - Rows: $ROWS"
          echo "  - Workers: $WORKERS" 
          echo "  - Memory: $MEMORY MB"

      - name: ğŸ“¥ Download and validate file
        run: |
          FILE_URL="${{ steps.extract-params.outputs.file_url }}"
          if [ -z "$FILE_URL" ]; then
            echo "âŒ No valid JSON file URL found in issue body"
            echo "Please provide a direct link to a JSON file in your issue."
            exit 1
          fi
          
          echo "ğŸŒ Downloading file from: $FILE_URL"
          curl -L -o input.json "$FILE_URL" --silent --show-error

      - name: ğŸ§ª Validate JSON format
        run: |
          python -c "
          import json
          import sys
          try:
              with open('input.json', 'r') as f:
                  json.load(f)
              print('âœ… JSON file is valid')
          except json.JSONDecodeError as e:
              print(f'âŒ Invalid JSON file: {e}')
              sys.exit(1)
          except Exception as e:
              print(f'âŒ Error reading file: {e}')
              sys.exit(1)
          "

      - name: ğŸš€ Run DataGenerator
        run: |
          echo "ğŸ”§ Starting DataGenerator with extracted parameters..."
          python main.py \
            -c input.json \
            -r ${{ steps.extract-params.outputs.rows }} \
            --enable_all_features \
            --output_dir output_files \
            -f csv \
            -w ${{ steps.extract-params.outputs.workers }} \
            -m ${{ steps.extract-params.outputs.memory }}

      - name: ğŸ“¤ Upload output folder
        uses: actions/upload-artifact@v4
        with:
          name: output-folder-issue-${{ github.event.issue.number }}
          path: output_files/
          retention-days: 30

      - name: ğŸ’¬ Enhanced completion comment
        if: always()
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            const status = '${{ job.status }}' === 'success' ? 'âœ… Completed' : 'âŒ Failed';
            const emoji = '${{ job.status }}' === 'success' ? 'ğŸ‰' : 'ğŸ’¥';
            
            let outputInfo = '';
            let fileCount = 0;
            try {
              if (fs.existsSync('output_files')) {
                const files = fs.readdirSync('output_files');
                fileCount = files.length;
                outputInfo = files.map(f => `- ğŸ“„ \`${f}\``).join('\n');
              }
            } catch (e) {
              outputInfo = 'Files generated (list unavailable)';
            }
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ${emoji} DataGenerator Processing ${status}!
              
              **ğŸ“Š Enhanced Results:**
              - **â±ï¸ Completed**: ${new Date().toISOString().replace('T', ' ').slice(0, 19)} UTC
              - **ğŸ“ˆ Rows Generated**: ${{ steps.extract-params.outputs.rows }}
              - **ğŸ“„ Files Created**: ${fileCount}
              - **ğŸ“ Status**: ${status}
              - **ğŸ”” Notification**: Enhanced multi-channel system
              
              ${outputInfo && `**ğŸ“„ Generated Files:**\n${outputInfo}\n`}
              
              **ğŸ“¥ Multiple Download Options:**
              - [ğŸ“¦ Direct Artifacts Download](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              - [ğŸ“‹ Complete Workflow Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              - [ğŸ”„ Run Again](https://github.com/${{ github.repository }}/actions)
              
              ---
              *ğŸ¤– Enhanced processing complete! Thank you for using DataGenerator.*`
            });

  # Pull request job for file upload via PRs
  run-script-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: ğŸ Setup Python with caching
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: âš¡ Install dependencies (cached)
        run: |
          python -m pip install --upgrade pip --quiet
          if [ -f requirements.txt ]; then 
            pip install -r requirements.txt --quiet --no-warn-script-location
          else
            pip install pandas numpy --quiet --no-warn-script-location
          fi

      - name: ğŸ” Find uploaded JSON files
        id: find-files
        run: |
          # Find all JSON files in uploads directory
          JSON_FILES=$(find uploads/ -name "*.json" -type f 2>/dev/null || echo "")
          
          if [ -z "$JSON_FILES" ]; then
            echo "âŒ No JSON files found in uploads/ directory"
            echo "Please ensure your JSON files are in the uploads/ folder"
            exit 1
          fi
          
          # Use the first JSON file found
          FIRST_FILE=$(echo "$JSON_FILES" | head -1)
          echo "input_file=$FIRST_FILE" >> $GITHUB_OUTPUT
          
          echo "ğŸ” Found JSON files:"
          echo "$JSON_FILES"
          echo "ğŸ“ Using file: $FIRST_FILE"

      - name: ğŸ“‚ Prepare input file
        run: |
          cp "${{ steps.find-files.outputs.input_file }}" input.json
          echo "ğŸ“ Using uploaded file: ${{ steps.find-files.outputs.input_file }}"

      - name: âœ… Check and validate input file
        run: |
          echo "ğŸ“Š Input file details:"
          ls -lh input.json
          echo "ğŸ” File preview (first 10 lines):"
          head -n 10 input.json

      - name: ğŸ§ª Validate JSON format
        run: |
          python -c "
          import json
          import sys
          try:
              with open('input.json', 'r') as f:
                  json.load(f)
              print('âœ… JSON file is valid')
          except json.JSONDecodeError as e:
              print(f'âŒ Invalid JSON file: {e}')
              sys.exit(1)
          except Exception as e:
              print(f'âŒ Error reading file: {e}')
              sys.exit(1)
          "

      - name: ğŸš€ Run DataGenerator with default parameters
        run: |
          echo "ğŸ”§ Running DataGenerator with default parameters for PR:"
          echo "  - Rows: 10 (default)"
          echo "  - Workers: 4 (default)"
          echo "  - Memory: 1024 MB (default)"
          
          python main.py \
            -c input.json \
            -r 10 \
            --enable_all_features \
            --output_dir output_files \
            -f csv \
            -w 4 \
            -m 1024

      - name: ğŸ“¤ Upload output folder
        uses: actions/upload-artifact@v4
        with:
          name: output-folder-pr-${{ github.event.pull_request.number }}
          path: output_files/
          retention-days: 30

      - name: ğŸ’¬ Enhanced PR completion comment
        if: always()
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            const status = '${{ job.status }}' === 'success' ? 'âœ… Completed' : 'âŒ Failed';
            const emoji = '${{ job.status }}' === 'success' ? 'ğŸ‰' : 'ğŸ’¥';
            
            let outputInfo = '';
            let fileCount = 0;
            try {
              if (fs.existsSync('output_files')) {
                const files = fs.readdirSync('output_files');
                fileCount = files.length;
                outputInfo = files.map(f => {
                  const stats = fs.statSync(`output_files/${f}`);
                  const sizeKB = (stats.size / 1024).toFixed(1);
                  return `- ğŸ“„ \`${f}\` (${sizeKB} KB)`;
                }).join('\n');
              }
            } catch (e) {
              outputInfo = 'Files generated (details unavailable)';
            }
            
            const comment = `## ${emoji} Enhanced DataGenerator Processing ${status}!
            
            **ğŸ“Š PR Processing Results:**
            - **ğŸ”„ Trigger**: Pull Request #${{ github.event.pull_request.number }}
            - **ğŸ“ Input File**: \`${{ steps.find-files.outputs.input_file }}\`
            - **â±ï¸ Completed**: ${new Date().toISOString().replace('T', ' ').slice(0, 19)} UTC
            - **ğŸ“„ Files Generated**: ${fileCount}
            - **ğŸ“ Status**: ${status}
            - **ğŸ”” Enhancement**: Multi-channel notification system
            
            **ğŸ“„ Generated Files:**
            ${outputInfo || 'âŒ No output files generated'}
            
            **ğŸ“¥ Enhanced Download Options**: 
            - [ğŸ“¦ Download Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [ğŸ“‹ View Full Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [ğŸ”„ Run Again](https://github.com/${{ github.repository }}/actions)
            
            ---
            *ğŸ¤– Enhanced PR processing complete! Multi-channel notifications active.*`;
            
            github.rest.pulls.createReview({
              pull_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment,
              event: 'COMMENT'
            });