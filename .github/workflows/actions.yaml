# Advanced workflow with multiple simultaneous notification methods
name: Run DataGenerator Utility (Multi-Notifications)

on:
  workflow_dispatch:
    inputs:
      rows:
        description: 'Number of rows need to generate'
        required: false
        default: '10'
      max_workers:
        description: 'Number of workers need to use'
        required: false
        default: 4
      max_memory_mb:
        description: 'How much memory needs to use (in MB)'
        required: false
        default: 1024
      input_method:
        description: 'Input method for JSON file'
        required: true
        type: choice
        options:
          - 'url'
          - 'repository_file'
        default: 'repository_file'
      file_url:
        description: 'URL of the input JSON file to download (only if input_method is "url")'
        required: false
        default: 'https://raw.githubusercontent.com/sunnygupta4197/DataGenerator/master/examples/example5.json'
      repository_file_path:
        description: 'Path to JSON file in repository (only if input_method is "repository_file")'
        required: false
        default: 'examples/example3.json'

      # Multiple notification toggles
      enable_workflow_summary:
        description: 'ğŸ“‹ Enable workflow summary notifications'
        required: false
        type: boolean
        default: true
      enable_slack_notifications:
        description: 'ğŸ“± Enable Slack notifications'
        required: false
        type: boolean
        default: false
      enable_issue_comments:
        description: 'ğŸ’¬ Enable issue comment notifications'
        required: false
        type: boolean
        default: true
      enable_email_prep:
        description: 'ğŸ“§ Enable email content preparation'
        required: false
        type: boolean
        default: false
      enable_webhook_notifications:
        description: 'ğŸ”— Enable custom webhook notifications'
        required: false
        type: boolean
        default: false
      enable_discord_notifications:
        description: 'ğŸ® Enable Discord notifications'
        required: false
        type: boolean
        default: false

      # Notification configuration
      slack_webhook_url:
        description: 'Slack webhook URL (if Slack enabled)'
        required: false
      discord_webhook_url:
        description: 'Discord webhook URL (if Discord enabled)'
        required: false
      custom_webhook_url:
        description: 'Custom webhook URL (if custom webhook enabled)'
        required: false
      email_address:
        description: 'Email address for notifications (if email enabled)'
        required: false
      notification_issue_number:
        description: 'Issue number for comments (if issue comments enabled, leave empty to auto-create)'
        required: false

  # Issue-based file upload trigger
  issues:
    types: [opened, edited]

  # Pull request based file upload
  pull_request:
    paths: ['uploads/**/*.json']
    types: [opened, synchronize]

# Required permissions
permissions:
  contents: read
  actions: read
  issues: write
  pull-requests: write
  id-token: write

# Global environment variables
env:
  PYTHONUNBUFFERED: 1
  PIP_DISABLE_PIP_VERSION_CHECK: 1
  PIP_NO_COLOR: 1

jobs:
  run-script-manual:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¢ Initialize workflow and notifications
        id: init
        run: |
          echo "ğŸš€ DataGenerator workflow starting with multiple notifications..."
          echo "ğŸ“Š Notification methods enabled:"
          echo "  - Workflow Summary: ${{ github.event.inputs.enable_workflow_summary }}"
          echo "  - Slack: ${{ github.event.inputs.enable_slack_notifications }}"
          echo "  - Issue Comments: ${{ github.event.inputs.enable_issue_comments }}"
          echo "  - Email Prep: ${{ github.event.inputs.enable_email_prep }}"
          echo "  - Custom Webhook: ${{ github.event.inputs.enable_webhook_notifications }}"
          echo "  - Discord: ${{ github.event.inputs.enable_discord_notifications }}"
          
          # Set outputs for all notification methods
          echo "start_time=$(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_OUTPUT
          echo "run_url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT
          echo "timestamp=$(date +%s)" >> $GITHUB_OUTPUT
          
          # Create notification summary
          METHODS=""
          [ "${{ github.event.inputs.enable_workflow_summary }}" = "true" ] && METHODS="$METHODSğŸ“‹ Summary "
          [ "${{ github.event.inputs.enable_slack_notifications }}" = "true" ] && METHODS="$METHODSğŸ“± Slack "
          [ "${{ github.event.inputs.enable_issue_comments }}" = "true" ] && METHODS="$METHODSğŸ’¬ Issues "
          [ "${{ github.event.inputs.enable_email_prep }}" = "true" ] && METHODS="$METHODSğŸ“§ Email "
          [ "${{ github.event.inputs.enable_webhook_notifications }}" = "true" ] && METHODS="$METHODSğŸ”— Webhook "
          [ "${{ github.event.inputs.enable_discord_notifications }}" = "true" ] && METHODS="$METHODSğŸ® Discord "
          
          echo "notification_methods=$METHODS" >> $GITHUB_OUTPUT

      # 1. WORKFLOW SUMMARY NOTIFICATION
      - name: ğŸ“‹ Create workflow summary notification
        if: github.event.inputs.enable_workflow_summary == 'true'
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ğŸš€ DataGenerator Multi-Channel Notification Started!
          
          ## ğŸ“Š Run Information
          | Parameter | Value |
          |-----------|-------|
          | ğŸ‘¤ **Triggered by** | @${{ github.actor }} |
          | ğŸ•’ **Started at** | ${{ steps.init.outputs.start_time }} |
          | ğŸ†” **Run ID** | [${{ github.run_id }}](${{ steps.init.outputs.run_url }}) |
          | ğŸ“¥ **Input Method** | ${{ github.event.inputs.input_method }} |
          | ğŸ“ **Source** | ${{ github.event.inputs.input_method == 'url' && github.event.inputs.file_url || github.event.inputs.repository_file_path }} |
          | ğŸ”” **Notifications** | ${{ steps.init.outputs.notification_methods }} |
          
          ## âš™ï¸ Processing Configuration
          | Setting | Value |
          |---------|-------|
          | ğŸ“ˆ **Rows to Generate** | ${{ github.event.inputs.rows }} |
          | âš™ï¸ **Workers** | ${{ github.event.inputs.max_workers }} |
          | ğŸ’¾ **Memory Limit** | ${{ github.event.inputs.max_memory_mb }} MB |
          
          ## ğŸ”” Active Notification Channels
          - ${{ github.event.inputs.enable_workflow_summary == 'true' && 'âœ…' || 'âŒ' }} **Workflow Summary** - Rich dashboard in Actions
          - ${{ github.event.inputs.enable_slack_notifications == 'true' && 'âœ…' || 'âŒ' }} **Slack** - Team notifications with buttons
          - ${{ github.event.inputs.enable_issue_comments == 'true' && 'âœ…' || 'âŒ' }} **Issue Comments** - GitHub issue updates
          - ${{ github.event.inputs.enable_email_prep == 'true' && 'âœ…' || 'âŒ' }} **Email Preparation** - Email content ready for sending
          - ${{ github.event.inputs.enable_webhook_notifications == 'true' && 'âœ…' || 'âŒ' }} **Custom Webhook** - API notifications
          - ${{ github.event.inputs.enable_discord_notifications == 'true' && 'âœ…' || 'âŒ' }} **Discord** - Gaming community updates
          
          ## ğŸ”— Quick Links
          - [ğŸ“Š Live Workflow Progress](${{ steps.init.outputs.run_url }})
          - [ğŸ“‹ All Workflow Runs](https://github.com/${{ github.repository }}/actions)
          - [ğŸ“ Repository](https://github.com/${{ github.repository }})
          
          ---
          â³ **Status**: Processing... (this summary will update when complete)
          EOF

      # 2. SLACK NOTIFICATION
      - name: ğŸ“± Send Slack start notification
        if: github.event.inputs.enable_slack_notifications == 'true' && github.event.inputs.slack_webhook_url != ''
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "ğŸš€ DataGenerator Multi-Channel Workflow Started",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸš€ DataGenerator Started (Multi-Channel)"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸ‘¤ User:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn", 
                      "text": "*ğŸ•’ Started:*\n${{ steps.init.outputs.start_time }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ğŸ“ˆ Rows:*\n${{ github.event.inputs.rows }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*âš™ï¸ Workers:*\n${{ github.event.inputs.max_workers }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸ”” Notifications:* ${{ steps.init.outputs.notification_methods }}\n*ğŸ“ Input:* ${{ github.event.inputs.input_method == 'url' && 'ğŸŒ URL' || 'ğŸ“‚ Repository File' }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ğŸ“Š View Progress"
                      },
                      "url": "${{ steps.init.outputs.run_url }}"
                    }
                  ]
                }
              ]
            }' \
            "${{ github.event.inputs.slack_webhook_url }}"

      # 3. DISCORD NOTIFICATION
      - name: ğŸ® Send Discord start notification
        if: github.event.inputs.enable_discord_notifications == 'true' && github.event.inputs.discord_webhook_url != ''
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "embeds": [
                {
                  "title": "ğŸš€ DataGenerator Started",
                  "description": "Multi-channel workflow initiated with multiple notification methods",
                  "color": 3447003,
                  "fields": [
                    {
                      "name": "ğŸ‘¤ User",
                      "value": "${{ github.actor }}",
                      "inline": true
                    },
                    {
                      "name": "ğŸ“ˆ Rows",
                      "value": "${{ github.event.inputs.rows }}",
                      "inline": true
                    },
                    {
                      "name": "âš™ï¸ Workers",
                      "value": "${{ github.event.inputs.max_workers }}",
                      "inline": true
                    },
                    {
                      "name": "ğŸ•’ Started",
                      "value": "${{ steps.init.outputs.start_time }}",
                      "inline": false
                    },
                    {
                      "name": "ğŸ”” Active Channels",
                      "value": "${{ steps.init.outputs.notification_methods }}",
                      "inline": false
                    }
                  ],
                  "footer": {
                    "text": "DataGenerator Workflow"
                  },
                  "timestamp": "${{ steps.init.outputs.start_time }}"
                }
              ]
            }' \
            "${{ github.event.inputs.discord_webhook_url }}"

      # 4. ISSUE COMMENT NOTIFICATION
      - name: ğŸ’¬ Send issue comment notification
        if: github.event.inputs.enable_issue_comments == 'true'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            let issueNumber = '${{ github.event.inputs.notification_issue_number }}';
            
            // If no issue number provided, find or create a notifications issue
            if (!issueNumber) {
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'notifications',
                per_page: 1
              });
              
              if (issues.data.length > 0) {
                issueNumber = issues.data[0].number;
              } else {
                const newIssue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'ğŸ”” DataGenerator Multi-Channel Notifications',
                  body: 'This issue tracks DataGenerator workflow notifications across multiple channels. Subscribe to get updates!',
                  labels: ['notifications', 'multi-channel', 'automated']
                });
                issueNumber = newIssue.data.number;
              }
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## ğŸš€ Multi-Channel DataGenerator Started - Run #${{ github.run_number }}
              
              **ğŸ“Š Quick Details:**
              - **ğŸ‘¤ User**: @${{ github.actor }}
              - **ğŸ•’ Started**: ${{ steps.init.outputs.start_time }}
              - **ğŸ“ˆ Config**: ${{ github.event.inputs.rows }} rows | ${{ github.event.inputs.max_workers }} workers | ${{ github.event.inputs.max_memory_mb }}MB
              - **ğŸ“¥ Source**: ${{ github.event.inputs.input_method == 'url' && 'ğŸŒ URL' || 'ğŸ“‚ Repository' }}
              - **ğŸ”” Channels**: ${{ steps.init.outputs.notification_methods }}
              
              **ğŸ”— [View Live Progress â†’](${{ steps.init.outputs.run_url }})**
              
              ---`
            });

      # 5. EMAIL PREPARATION
      - name: ğŸ“§ Prepare email notification content
        if: github.event.inputs.enable_email_prep == 'true' && github.event.inputs.email_address != ''
        run: |
          mkdir -p email_notifications
          
          # Create email content files
          cat > email_notifications/start_email.txt << 'EOF'
          Subject: ğŸš€ DataGenerator Multi-Channel Started - Run #${{ github.run_number }}
          To: ${{ github.event.inputs.email_address }}
          
          DataGenerator Multi-Channel Workflow Started
          ==========================================
          
          Your DataGenerator workflow has started with multiple notification channels active.
          
          Run Details:
          -----------
          - User: ${{ github.actor }}
          - Started: ${{ steps.init.outputs.start_time }}
          - Run ID: ${{ github.run_id }}
          - Input Method: ${{ github.event.inputs.input_method }}
          - Rows to Generate: ${{ github.event.inputs.rows }}
          - Workers: ${{ github.event.inputs.max_workers }}
          - Memory Limit: ${{ github.event.inputs.max_memory_mb }} MB
          
          Active Notification Channels:
          ----------------------------
          ${{ steps.init.outputs.notification_methods }}
          
          Progress Tracking:
          -----------------
          View live progress: ${{ steps.init.outputs.run_url }}
          
          You will receive completion notifications through all enabled channels.
          
          ---
          Automated Multi-Channel Notification from DataGenerator
          Repository: ${{ github.repository }}
          EOF
          
          echo "ğŸ“§ Email content prepared for: ${{ github.event.inputs.email_address }}"
          echo "ğŸ“„ Email file created: email_notifications/start_email.txt"

      # 6. CUSTOM WEBHOOK NOTIFICATION
      - name: ğŸ”— Send custom webhook notification
        if: github.event.inputs.enable_webhook_notifications == 'true' && github.event.inputs.custom_webhook_url != ''
        run: |
          curl -X POST -H 'Content-Type: application/json' \
            --data '{
              "event": "workflow_started",
              "workflow": "DataGenerator Multi-Channel",
              "run_id": "${{ github.run_id }}",
              "run_number": ${{ github.run_number }},
              "actor": "${{ github.actor }}",
              "started_at": "${{ steps.init.outputs.start_time }}",
              "repository": "${{ github.repository }}",
              "parameters": {
                "input_method": "${{ github.event.inputs.input_method }}",
                "rows": ${{ github.event.inputs.rows }},
                "workers": ${{ github.event.inputs.max_workers }},
                "memory_mb": ${{ github.event.inputs.max_memory_mb }},
                "source": "${{ github.event.inputs.input_method == 'url' && github.event.inputs.file_url || github.event.inputs.repository_file_path }}"
              },
              "notification_channels": "${{ steps.init.outputs.notification_methods }}",
              "urls": {
                "workflow_run": "${{ steps.init.outputs.run_url }}",
                "repository": "https://github.com/${{ github.repository }}"
              },
              "status": "started"
            }' \
            "${{ github.event.inputs.custom_webhook_url }}"

      # Main workflow execution steps
      - name: ğŸ“ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python with caching
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
          cache-dependency-path: '**/requirements.txt'

      - name: ğŸ“¦ Cache pip packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.local/lib/python3.9/site-packages
          key: ${{ runner.os }}-python-3.9-pip-${{ hashFiles('**/requirements.txt', '**/setup.py', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-python-3.9-pip-

      - name: âš¡ Install dependencies (cached)
        run: |
          python -m pip install --upgrade pip --quiet
          if [ -f requirements.txt ]; then 
            echo "ğŸ“‹ Installing from requirements.txt..."
            pip install -r requirements.txt --quiet --no-warn-script-location
          else
            echo "âš ï¸  No requirements.txt found, installing common packages..."
            pip install pandas numpy --quiet --no-warn-script-location
          fi

      - name: ğŸ“¥ Prepare input file from URL
        if: github.event.inputs.input_method == 'url'
        run: |
          echo "ğŸŒ Downloading file from URL: ${{ github.event.inputs.file_url }}"
          curl -L -o input.json "${{ github.event.inputs.file_url }}" --silent --show-error

      - name: ğŸ“‚ Prepare input file from repository
        if: github.event.inputs.input_method == 'repository_file'
        run: |
          echo "ğŸ“ Using file from repository: ${{ github.event.inputs.repository_file_path }}"
          cp "${{ github.event.inputs.repository_file_path }}" input.json

      - name: âœ… Validate input file
        run: |
          if [ ! -f input.json ]; then
            echo "âŒ Error: input.json file not found!"
            exit 1
          fi
          
          echo "ğŸ“Š Input file details:"
          ls -lh input.json

      - name: ğŸ§ª Validate JSON format
        run: |
          python -c "
          import json
          import sys
          try:
              with open('input.json', 'r') as f:
                  data = json.load(f)
              print('âœ… JSON file is valid')
          except json.JSONDecodeError as e:
              print(f'âŒ Invalid JSON file: {e}')
              sys.exit(1)
          except Exception as e:
              print(f'âŒ Error reading file: {e}')
              sys.exit(1)
          "

      - name: ğŸš€ Run DataGenerator
        run: |
          echo "ğŸ”§ Starting DataGenerator with parameters:"
          echo "  - Rows: ${{ github.event.inputs.rows }}"
          echo "  - Workers: ${{ github.event.inputs.max_workers }}"
          echo "  - Memory: ${{ github.event.inputs.max_memory_mb }} MB"
          
          python optimized_main.py \
            -c input.json \
            -r ${{ github.event.inputs.rows }} \
            --enable_all_features \
            --output_dir output_files \
            -f csv \
            -w ${{ github.event.inputs.max_workers }} \
            -m ${{ github.event.inputs.max_memory_mb }}

      - name: ğŸ“¤ Upload output folder
        uses: actions/upload-artifact@v4
        with:
          name: output-folder-multi-${{ github.run_number }}
          path: output_files/
          retention-days: 30

      - name: ğŸ“Š Gather completion statistics
        if: always()
        id: stats
        run: |
          # Get completion status
          STATUS="${{ job.status }}"
          COMPLETION_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          if [ "$STATUS" = "success" ]; then
            EMOJI="ğŸ‰"
            STATUS_TEXT="âœ… Completed Successfully"
            COLOR="good"
            DISCORD_COLOR=3066993
          else
            EMOJI="ğŸ’¥"
            STATUS_TEXT="âŒ Failed"
            COLOR="danger"
            DISCORD_COLOR=15158332
          fi
          
          # Count output files and calculate sizes
          FILE_COUNT=0
          TOTAL_SIZE="0 B"
          FILE_LIST=""
          
          if [ -d "output_files" ]; then
            FILE_COUNT=$(ls output_files | wc -l)
            
            # Calculate total size (cross-platform)
            if command -v stat >/dev/null 2>&1; then
              if stat -f%z . >/dev/null 2>&1; then
                # BSD/macOS stat
                TOTAL_BYTES=$(find output_files -type f -exec stat -f%z {} \; | awk '{sum += $1} END {print sum+0}')
              else
                # GNU/Linux stat
                TOTAL_BYTES=$(find output_files -type f -exec stat -c%s {} \; | awk '{sum += $1} END {print sum+0}')
              fi
            else
              TOTAL_BYTES=0
            fi
            
            if [ "$TOTAL_BYTES" -gt 1048576 ]; then
              TOTAL_SIZE="$(echo "$TOTAL_BYTES" | awk '{printf "%.1fMB", $1/1048576}')"
            elif [ "$TOTAL_BYTES" -gt 1024 ]; then
              TOTAL_SIZE="$(echo "$TOTAL_BYTES" | awk '{printf "%.1fKB", $1/1024}')"
            else
              TOTAL_SIZE="${TOTAL_BYTES}B"
            fi
            
            # Create file list
            for file in output_files/*; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                FILE_LIST="$FILE_LIST\n- ğŸ“„ \`$filename\`"
              fi
            done
          fi
          
          # Set outputs for completion notifications
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "status_text=$STATUS_TEXT" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          echo "discord_color=$DISCORD_COLOR" >> $GITHUB_OUTPUT
          echo "completion_time=$COMPLETION_TIME" >> $GITHUB_OUTPUT
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "total_size=$TOTAL_SIZE" >> $GITHUB_OUTPUT
          echo "file_list<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FILE_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # COMPLETION NOTIFICATIONS (ALL METHODS)

      # 1. UPDATE WORKFLOW SUMMARY
      - name: ğŸ“‹ Update workflow summary (completion)
        if: github.event.inputs.enable_workflow_summary == 'true' && always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          
          ---
          
          # ${{ steps.stats.outputs.emoji }} DataGenerator ${{ steps.stats.outputs.status_text }}
          
          ## ğŸ“Š Final Results
          | Metric | Value |
          |--------|-------|
          | ğŸŸ¢ **Status** | ${{ steps.stats.outputs.status_text }} |
          | â±ï¸ **Completed** | ${{ steps.stats.outputs.completion_time }} |
          | ğŸ“„ **Files Generated** | ${{ steps.stats.outputs.file_count }} |
          | ğŸ’¾ **Total Size** | ${{ steps.stats.outputs.total_size }} |
          | ğŸ”” **Notification Channels** | ${{ steps.init.outputs.notification_methods }} |
          
          ## ğŸ“„ Generated Files
          ${{ steps.stats.outputs.file_list }}
          
          ## ğŸ“¥ Download Options
          - [ğŸ“¦ Download All Files](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [ğŸ“‹ View Complete Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [ğŸ”„ Run Again](https://github.com/${{ github.repository }}/actions/workflows/$(basename "${{ github.workflow_ref }}" .yml).yml)
          
          ## ğŸ”” Notification Summary
          All enabled notification channels have been updated with completion status:
          - ${{ github.event.inputs.enable_workflow_summary == 'true' && 'âœ…' || 'âŒ' }} Workflow Summary
          - ${{ github.event.inputs.enable_slack_notifications == 'true' && 'âœ…' || 'âŒ' }} Slack Notifications  
          - ${{ github.event.inputs.enable_issue_comments == 'true' && 'âœ…' || 'âŒ' }} Issue Comments
          - ${{ github.event.inputs.enable_email_prep == 'true' && 'âœ…' || 'âŒ' }} Email Preparation
          - ${{ github.event.inputs.enable_webhook_notifications == 'true' && 'âœ…' || 'âŒ' }} Custom Webhook
          - ${{ github.event.inputs.enable_discord_notifications == 'true' && 'âœ…' || 'âŒ' }} Discord Notifications
          
          ---
          ${{ steps.stats.outputs.emoji }} **Multi-channel workflow completed at ${{ steps.stats.outputs.completion_time }}**
          EOF

      # 2. SLACK COMPLETION
      - name: ğŸ“± Send Slack completion notification
        if: github.event.inputs.enable_slack_notifications == 'true' && github.event.inputs.slack_webhook_url != '' && always()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"${{ steps.stats.outputs.emoji }} DataGenerator ${{ steps.stats.outputs.status_text }}\",
              \"attachments\": [
                {
                  \"color\": \"${{ steps.stats.outputs.color }}\",
                  \"fields\": [
                    {
                      \"title\": \"Status\",
                      \"value\": \"${{ steps.stats.outputs.status_text }}\",
                      \"short\": true
                    },
                    {
                      \"title\": \"Files Generated\",
                      \"value\": \"${{ steps.stats.outputs.file_count }}\",
                      \"short\": true
                    },
                    {
                      \"title\": \"Total Size\",
                      \"value\": \"${{ steps.stats.outputs.total_size }}\",
                      \"short\": true
                    },
                    {
                      \"title\": \"Run #\",
                      \"value\": \"${{ github.run_number }}\",
                      \"short\": true
                    },
                    {
                      \"title\": \"Completed\",
                      \"value\": \"${{ steps.stats.outputs.completion_time }}\",
                      \"short\": false
                    },
                    {
                      \"title\": \"Notification Channels\",
                      \"value\": \"${{ steps.init.outputs.notification_methods }}\",
                      \"short\": false
                    }
                  ],
                  \"actions\": [
                    {
                      \"type\": \"button\",
                      \"text\": \"ğŸ“¥ Download Results\",
                      \"url\": \"${{ steps.init.outputs.run_url }}\"
                    }
                  ]
                }
              ]
            }" \
            "${{ github.event.inputs.slack_webhook_url }}"

      # 3. DISCORD COMPLETION
      - name: ğŸ® Send Discord completion notification
        if: github.event.inputs.enable_discord_notifications == 'true' && github.event.inputs.discord_webhook_url != '' && always()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"embeds\": [
                {
                  \"title\": \"${{ steps.stats.outputs.emoji }} DataGenerator ${{ steps.stats.outputs.status_text }}\",
                  \"description\": \"Multi-channel workflow completed with notifications sent to all enabled channels\",
                  \"color\": ${{ steps.stats.outputs.discord_color }},
                  \"fields\": [
                    {
                      \"name\": \"ğŸ“Š Files Generated\",
                      \"value\": \"${{ steps.stats.outputs.file_count }}\",
                      \"inline\": true
                    },
                    {
                      \"name\": \"ğŸ’¾ Total Size\",
                      \"value\": \"${{ steps.stats.outputs.total_size }}\",
                      \"inline\": true
                    },
                    {
                      \"name\": \"ğŸ”¢ Run Number\",
                      \"value\": \"#${{ github.run_number }}\",
                      \"inline\": true
                    },
                    {
                      \"name\": \"â±ï¸ Completed\",
                      \"value\": \"${{ steps.stats.outputs.completion_time }}\",
                      \"inline\": false
                    },
                    {
                      \"name\": \"ğŸ”” Notification Channels\",
                      \"value\": \"${{ steps.init.outputs.notification_methods }}\",
                      \"inline\": false
                    }
                  ],
                  \"footer\": {
                    \"text\": \"DataGenerator Multi-Channel Workflow\"
                  },
                  \"timestamp\": \"${{ steps.stats.outputs.completion_time }}\"
                }
              ]
            }" \
            "${{ github.event.inputs.discord_webhook_url }}"

      # 4. ISSUE COMMENT COMPLETION
      - name: ğŸ’¬ Send issue completion comment
        if: github.event.inputs.enable_issue_comments == 'true' && always()
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            let issueNumber = '${{ github.event.inputs.notification_issue_number }}';
            
            // Find the notifications issue if no number provided
            if (!issueNumber) {
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'notifications',
                per_page: 1
              });
              
              if (issues.data.length > 0) {
                issueNumber = issues.data[0].number;
              }
            }
            
            if (issueNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `## ${{ steps.stats.outputs.emoji }} Multi-Channel Run #${{ github.run_number }} ${{ steps.stats.outputs.status_text }}
                
                **ğŸ“Š Final Results:**
                - **â±ï¸ Completed**: ${{ steps.stats.outputs.completion_time }}
                - **ğŸ“„ Files Generated**: ${{ steps.stats.outputs.file_count }}
                - **ğŸ’¾ Total Size**: ${{ steps.stats.outputs.total_size }}
                - **ğŸ“ Status**: ${{ steps.stats.outputs.status_text }}
                
                **ğŸ”” All Notification Channels Updated:**
                ${{ steps.init.outputs.notification_methods }}
                
                **ğŸ“¥ Download Results**: [Workflow Artifacts](${{ steps.init.outputs.run_url }})
                
                ---
                *ğŸ¤– Multi-channel processing complete!*`
              });
            }

      # 5. EMAIL COMPLETION PREPARATION
      - name: ğŸ“§ Prepare completion email content
        if: github.event.inputs.enable_email_prep == 'true' && github.event.inputs.email_address != '' && always()
        run: |
          cat > email_notifications/completion_email.txt << EOF
          Subject: ${{ steps.stats.outputs.emoji }} DataGenerator Multi-Channel ${{ steps.stats.outputs.status_text }} - Run #${{ github.run_number }}
          To: ${{ github.event.inputs.email_address }}
          
          DataGenerator Multi-Channel Workflow ${{ steps.stats.outputs.status_text }}
          =====================================================
          
          Your DataGenerator workflow has completed with the following results:
          
          Final Results:
          -------------
          - Status: ${{ steps.stats.outputs.status_text }}
          - Completed: ${{ steps.stats.outputs.completion_time }}
          - Files Generated: ${{ steps.stats.outputs.file_count }}
          - Total Size: ${{ steps.stats.outputs.total_size }}
          - Run Number: #${{ github.run_number }}
          
          Notification Channels Used:
          --------------------------
          ${{ steps.init.outputs.notification_methods }}
          
          Generated Files:
          ---------------
          ${{ steps.stats.outputs.file_list }}
          
          Download Results:
          ----------------
          Access your generated files: ${{ steps.init.outputs.run_url }}
          
          Run Details:
          -----------
          - Repository: ${{ github.repository }}
          - Triggered by: ${{ github.actor }}
          - Started: ${{ steps.init.outputs.start_time }}
          - Input Method: ${{ github.event.inputs.input_method }}
          - Configuration: ${{ github.event.inputs.rows }} rows, ${{ github.event.inputs.max_workers }} workers, ${{ github.event.inputs.max_memory_mb }}MB memory
          
          ---
          Automated Multi-Channel Completion Notification from DataGenerator
          All enabled notification channels have been updated with these results.
          EOF
          
          echo "ğŸ“§ Completion email content prepared"
          echo "ğŸ“„ Email file created: email_notifications/completion_email.txt"

      # 6. CUSTOM WEBHOOK COMPLETION
      - name: ğŸ”— Send custom webhook completion notification
        if: github.event.inputs.enable_webhook_notifications == 'true' && github.event.inputs.custom_webhook_url != '' && always()
        run: |
          curl -X POST -H 'Content-Type: application/json' \
            --data "{
              \"event\": \"workflow_completed\",
              \"workflow\": \"DataGenerator Multi-Channel\",
              \"run_id\": \"${{ github.run_id }}\",
              \"run_number\": ${{ github.run_number }},
              \"actor\": \"${{ github.actor }}\",
              \"started_at\": \"${{ steps.init.outputs.start_time }}\",
              \"completed_at\": \"${{ steps.stats.outputs.completion_time }}\",
              \"repository\": \"${{ github.repository }}\",
              \"status\": \"${{ steps.stats.outputs.status }}\",
              \"status_text\": \"${{ steps.stats.outputs.status_text }}\",
              \"results\": {
                \"files_generated\": ${{ steps.stats.outputs.file_count }},
                \"total_size\": \"${{ steps.stats.outputs.total_size }}\",
                \"success\": ${{ steps.stats.outputs.status == 'success' }}
              },
              \"parameters\": {
                \"input_method\": \"${{ github.event.inputs.input_method }}\",
                \"rows\": ${{ github.event.inputs.rows }},
                \"workers\": ${{ github.event.inputs.max_workers }},
                \"memory_mb\": ${{ github.event.inputs.max_memory_mb }}
              },
              \"notification_channels\": \"${{ steps.init.outputs.notification_methods }}\",
              \"urls\": {
                \"workflow_run\": \"${{ steps.init.outputs.run_url }}\",
                \"artifacts\": \"${{ steps.init.outputs.run_url }}\",
                \"repository\": \"https://github.com/${{ github.repository }}\"
              }
            }" \
            "${{ github.event.inputs.custom_webhook_url }}"

      # 7. UPLOAD EMAIL FILES AS ARTIFACTS
      - name: ğŸ“§ Upload email notifications as artifacts
        if: github.event.inputs.enable_email_prep == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: email-notifications-${{ github.run_number }}
          path: email_notifications/
          retention-days: 7

  # Issue-based job with multi-notifications
  run-script-issue:
    if: github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'data-upload')
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¢ Multi-channel issue start notification
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸš€ Multi-Channel DataGenerator Processing Started!
              
              **ğŸ“Š Status**: Processing your data file with enhanced notifications...
              **ğŸ•’ Started**: ${new Date().toISOString().replace('T', ' ').slice(0, 19)} UTC
              **ğŸ”— Live Progress**: [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              **ğŸ”” Notifications**: This workflow uses multiple notification channels for comprehensive updates
              
              I'll provide detailed updates when processing completes! ğŸ¯
              
              ---
              *ğŸ¤– Multi-channel automated notification from DataGenerator workflow*`
            });

      # ... (rest of issue processing steps same as before, but with enhanced notifications)
      - name: ğŸ“ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python with caching
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: âš¡ Install dependencies (cached)
        run: |
          python -m pip install --upgrade pip --quiet
          if [ -f requirements.txt ]; then 
            pip install -r requirements.txt --quiet --no-warn-script-location
          else
            pip install pandas numpy --quiet --no-warn-script-location
          fi

      - name: ğŸ“ Extract parameters from issue
        id: extract-params
        run: |
          ISSUE_BODY="${{ github.event.issue.body }}"
          
          FILE_URL=$(echo "$ISSUE_BODY" | grep -oE 'https?://[^[:space:]]+\.json[^[:space:]]*' | head -1)
          if [ -z "$FILE_URL" ]; then
            FILE_URL=$(echo "$ISSUE_BODY" | grep -oE 'https?://[^[:space:]]+' | grep -E '(raw\.githubusercontent|gist\.githubusercontent|file\.io|tmpfiles\.org)' | head -1)
          fi
          
          ROWS=$(echo "$ISSUE_BODY" | grep -oiE '(rows?|count)[[:space:]]*:?[[:space:]]*([0-9]+)' | grep -oE '[0-9]+' | head -1)
          ROWS=${ROWS:-10}
          
          WORKERS=$(echo "$ISSUE_BODY" | grep -oiE '(workers?|threads?)[[:space:]]*:?[[:space:]]*([0-9]+)' | grep -oE '[0-9]+' | head -1)
          WORKERS=${WORKERS:-4}
          
          MEMORY=$(echo "$ISSUE_BODY" | grep -oiE '(memory|mem)[[:space:]]*:?[[:space:]]*([0-9]+)' | grep -oE '[0-9]+' | head -1)
          MEMORY=${MEMORY:-1024}
          
          echo "file_url=$FILE_URL" >> $GITHUB_OUTPUT
          echo "rows=$ROWS" >> $GITHUB_OUTPUT
          echo "workers=$WORKERS" >> $GITHUB_OUTPUT
          echo "memory=$MEMORY" >> $GITHUB_OUTPUT

      - name: ğŸ“¥ Download and validate file
        run: |
          FILE_URL="${{ steps.extract-params.outputs.file_url }}"
          if [ -z "$FILE_URL" ]; then
            echo "âŒ No valid JSON file URL found"
            exit 1
          fi
          
          curl -L -o input.json "$FILE_URL" --silent --show-error
          
          python -c "
          import json
          with open('input.json', 'r') as f:
              json.load(f)
          print('âœ… JSON file is valid')
          "

      - name: ğŸš€ Run DataGenerator
        run: |
          python main.py \
            -c input.json \
            -r ${{ steps.extract-params.outputs.rows }} \
            --enable_all_features \
            --output_dir output_files \
            -f csv \
            -w ${{ steps.extract-params.outputs.workers }} \
            -m ${{ steps.extract-params.outputs.memory }}

      - name: ğŸ“¤ Upload output folder
        uses: actions/upload-artifact@v4
        with:
          name: output-folder-issue-${{ github.event.issue.number }}
          path: output_files/
          retention-days: 30

      - name: ğŸ’¬ Enhanced completion comment
        if: always()
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            const status = '${{ job.status }}' === 'success' ? 'âœ… Completed' : 'âŒ Failed';
            const emoji = '${{ job.status }}' === 'success' ? 'ğŸ‰' : 'ğŸ’¥';
            
            let outputInfo = '';
            let fileCount = 0;
            try {
              if (fs.existsSync('output_files')) {
                const files = fs.readdirSync('output_files');
                fileCount = files.length;
                outputInfo = files.map(f => `- ğŸ“„ \`${f}\``).join('\n');
              }
            } catch (e) {
              outputInfo = 'Files generated (list unavailable)';
            }
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ${emoji} Multi-Channel DataGenerator ${status}!
              
              **ğŸ“Š Enhanced Results:**
              - **â±ï¸ Completed**: ${new Date().toISOString().replace('T', ' ').slice(0, 19)} UTC
              - **ğŸ“ˆ Rows Generated**: ${{ steps.extract-params.outputs.rows }}
              - **ğŸ“„ Files Created**: ${fileCount}
              - **ğŸ“ Status**: ${status}
              - **ğŸ”” Notification Level**: Multi-Channel Enhanced
              
              ${outputInfo && `**ğŸ“„ Generated Files:**\n${outputInfo}\n`}
              
              **ğŸ“¥ Multiple Download Options:**
              - [ğŸ“¦ Direct Artifacts Download](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              - [ğŸ“‹ Complete Workflow Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              - [ğŸ”„ Run Again](https://github.com/${{ github.repository }}/actions)
              
              ---
              *ğŸ¤– Multi-channel processing complete! Enhanced notifications system active.*`
            });

  # Pull request job with multi-notifications
  run-script-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: ğŸ” Find and process uploaded files
        id: find-files
        run: |
          JSON_FILES=$(find uploads/ -name "*.json" -type f 2>/dev/null || echo "")
          
          if [ -z "$JSON_FILES" ]; then
            echo "âŒ No JSON files found in uploads/ directory"
            exit 1
          fi
          
          FIRST_FILE=$(echo "$JSON_FILES" | head -1)
          echo "input_file=$FIRST_FILE" >> $GITHUB_OUTPUT
          echo "ğŸ” Using file: $FIRST_FILE for multi-channel processing"

      # ... (rest of PR processing steps with enhanced notifications)

      - name: ğŸ’¬ Enhanced PR completion comment
        if: always()
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? 'âœ… Completed' : 'âŒ Failed';
            const emoji = '${{ job.status }}' === 'success' ? 'ğŸ‰' : 'ğŸ’¥';
            
            const comment = `## ${emoji} Multi-Channel DataGenerator ${status}!
            
            **ğŸ“Š Enhanced PR Processing Results:**
            - **ğŸ”„ Trigger**: Pull Request #${{ github.event.pull_request.number }}
            - **ğŸ“ Input File**: \`${{ steps.find-files.outputs.input_file }}\`
            - **â±ï¸ Completed**: ${new Date().toISOString().replace('T', ' ').slice(0, 19)} UTC
            - **ğŸ”” Enhancement**: Multi-channel notification system active
            
            **ğŸ“¥ Enhanced Download Options**: 
            [ğŸ“¦ Workflow Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) | [ğŸ“‹ Full Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) | [ğŸ”„ Rerun](https://github.com/${{ github.repository }}/actions)
            
            ---
            *ğŸ¤– Multi-channel PR processing complete!*`;
            
            github.rest.pulls.createReview({
              pull_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment,
              event: 'COMMENT'
            });